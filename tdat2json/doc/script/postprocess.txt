// populate the xref array
db.catalog.find().forEach(function(obj) {
    // star catalogs
    if (obj.bscname != null) {
        obj.xref.push(obj.bscname);
    }
    if (obj.ccdmname != null) {
        obj.xref.push(obj.ccdmname);
    }
    if (obj.cpdname != null) {
        obj.xref.push(obj.cpdname);
    }
    if (obj.dmname != null) {
        obj.xref.push(obj.dmname);
    }
    if (obj.gcname != null) {
        obj.xref.push(obj.gcname);
    }
    if (obj.gliesename != null) {
        obj.xref.push(obj.gliesename);
    }
    if (obj.hdname != null) {
        obj.xref.push(obj.hdname);
    }
    if (obj.hipname != null) {
        obj.xref.push(obj.hipname);
    }
    if (obj.ppmname != null) {
        obj.xref.push(obj.ppmname);
    }
    if (obj.saoname != null) {
        obj.xref.push(obj.saoname);
    }
    if (obj.lhsname != null) {
        obj.xref.push(obj.lhsname);
    }
    // galaxy catalogs
    if (obj.messiername != null) {
        obj.xref.push(obj.messiername);
    }
    if (obj.ngc2000name != null) {
        obj.xref.push(obj.ngc2000name);
    }
    if (obj.ugcname != null) {
        obj.xref.push(obj.ugcname);
    }
    if (obj.flamname !=null) {
        obj.xref.push(flamname);
    }
    if (obj.bayername != null) {
        obj.xref.push(bayername);
    }
    db.catalog.save(obj);
});

function fixArray2() {
    var counter = 0;
    // I only want the xref for each field, I don't even want the id
    var cursor = db.catalog.find({}, {xref: true, _id: false});

    // I don't want to init this inside the loop, worried about memory leaks (probably baseless worry)
    var consolidatedArray = [];
    while (cursor.hasNext()) {
        var xref1 = cursor.next().xref;
        // first pass: create a consolidated array when the cross references match
        var limitedCursor1 = db.catalog.find({"name":{$in:xref1}});
        while (limitedCursor1.hasNext()) {
            var doc1 = limitedCursor1.next();
            consolidatedArray = consolidatedArray.concat(doc1.xref);
        }
        consolidatedArray = consolidatedArray.unique();
        // now that we have the consolidated array, reset the xref field of the object to it
        for (var i=0; i<consolidatedArray.length; i++) {
            db.catalog.update({name:consolidatedArray[i]},{$set:{xref: consolidatedArray}},false, true);
        }

        consolidatedArray.length = 0;

        counter++;
        if (counter % 10000 == 0) {
            print("Processed " + counter + " documents.");
        }
    }
}

fixArray2();